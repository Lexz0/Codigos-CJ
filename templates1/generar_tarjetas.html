
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Generar Tarjetas â€” Instituto CJ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#0061ff;
      --brand-dark:#0047c2;
      --ok:#057a55;
      --warn:#b43403;
      --text:#1f2937;
      --muted:#6b7280;
      --bg:#ffffff;
      --panel:#f9fafb;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
      color:var(--text); background:var(--bg);
    }
    h1{margin:0 0 8px 0; font-size:22px}
    p.desc{margin:0 0 16px 0; color:var(--muted)}
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:12px 0 16px 0;
    }
    button{
      appearance:none; border:none; cursor:pointer; border-radius:8px;
      padding:12px 14px; font-size:14px; color:#fff; background:var(--brand);
    }
    button:hover{ background:var(--brand-dark); }
    button.secondary{ background:#374151; }
    button.secondary:hover{ background:#1f2937; }
    button.warn{ background:#b91c1c; }
    button.warn:hover{ background:#991b1b; }
    button:disabled{ opacity:.6; cursor:not-allowed }

    .row{ display:flex; flex-wrap:wrap; gap:16px; align-items:flex-start; }
    .card{
      background:var(--panel); border:1px solid var(--border); border-radius:12px;
      padding:16px; min-width:280px; flex:1 1 320px;
    }
    .title-sm{ font-weight:600; margin:0 0 6px 0; }
    .muted{ color:var(--muted); }
    .ok{ color:var(--ok); }
    .warn-txt{ color:var(--warn); }

    #loader{
      display:none; margin:10px 0;
      width:48px; height:48px; border:5px solid #e5e7eb; border-top:5px solid var(--brand);
      border-radius:50%; animation:spin 1s linear infinite;
    }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    .kv{ display:grid; grid-template-columns: 160px 1fr; gap:6px 12px; font-size:14px; }
    .kv div:nth-child(odd){ color:var(--muted) }

    pre{
      white-space:pre-wrap; background:#fff; border:1px dashed var(--border);
      padding:12px; margin:8px 0 0 0; border-radius:8px; max-height:280px; overflow:auto;
    }
    .footer-note{ margin-top:14px; font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <h1>Generar Tarjetas</h1>
  <p class="desc">Consulta cuÃ¡ntas tarjetas estÃ¡n pendientes, fuerza la actualizaciÃ³n del Excel si lo acabas de editar, y genera las tarjetas.</p>

  <div class="toolbar">
    <button id="btnRecontar" title="Consultar candidatos actuales (preview)">ðŸ”„ Recontar pendientes</button>
    <button id="btnRefresh" class="secondary" title="Borra copia local, espera versiÃ³n fresca por eTag y vuelve a descargar">ðŸ§¹ Forzar refresco</button>
    <button id="btnGenerar" class="warn" title="Generar tarjetas pendientes, enviar a Telegram y subir a OneDrive">ðŸš€ Generar Tarjetas</button>
    <div id="loader" aria-label="Cargando" role="status"></div>
  </div>

  <div class="row">
    <section class="card" style="max-width:520px">
      <div class="title-sm">Resumen</div>
      <div class="kv">
        <div>Ãšltima verificaciÃ³n:</div><div id="lastCheck" class="muted">â€”</div>
        <div>Total de filas:</div><div id="totalFilas">â€”</div>
        <div>Pendientes a generar:</div><div id="pendientes" class="ok">â€”</div>
        <div>Resultado (Ãºltima acciÃ³n):</div><div id="resultado" class="muted">â€”</div>
      </div>
      <div class="footer-note">
        Tip: si editaste el Excel Online hace segundos, usa <b>ðŸ§¹ Forzar refresco</b> para asegurar que el servidor descargue la versiÃ³n mÃ¡s reciente.
      </div>
    </section>

    <section class="card">
      <div class="title-sm">Detalle de candidatos (mÃ¡x. 20)</div>
      <pre id="detalle">â€”</pre>
    </section>
  </div>

  <script>
    const el = (id)=>document.getElementById(id);
    const fmtTime = ()=> new Date().toLocaleString();

    function setBusy(b){
      el("btnRecontar").disabled = b;
      el("btnRefresh").disabled = b;
      el("btnGenerar").disabled = b;
      el("loader").style.display = b ? "inline-block" : "none";
    }

    function setResumen({total=undefined, cand=undefined, msg="â€”"}={}){
      if (typeof total === "number") el("totalFilas").textContent = total;
      if (typeof cand  === "number") el("pendientes").textContent = cand;
      el("resultado").textContent = msg;
      el("lastCheck").textContent = fmtTime();
    }

    function renderDetalle(preview){
      try{
        const list = (preview || []).filter(p=>p.seria_generado);
        const top = list.slice(0, 20);
        if (top.length === 0){
          el("detalle").textContent = "No hay candidatos por generar.";
          return;
        }
        const lines = top.map(p => `â€¢ ${p.codigo} | ${p.nombre} | ${p.clase}`);
        el("detalle").textContent = lines.join("\n");
      }catch(err){
        el("detalle").textContent = "Error al renderizar detalle: " + err;
      }
    }

    async function apiPreview(){
      setBusy(true);
      try{
        const resp = await fetch("/generar-tarjetas-preview", {
          method: "GET",
          cache: "no-store",
          headers: {"Cache-Control":"no-cache"}
        });
        const data = await resp.json();
        if (data.error){
          setResumen({msg:"Error preview: " + data.error});
          el("detalle").textContent = "";
          return;
        }
        setResumen({total:data.total_filas, cand:data.candidatos_a_generar, msg:"Preview actualizado"});
        renderDetalle(data.preview);
      }catch(e){
        setResumen({msg:"Fallo preview: " + e});
        el("detalle").textContent = "";
      }finally{
        setBusy(false);
      }
    }

    async function apiForceRefresh(){
      setBusy(true);
      try{
        const resp = await fetch("/force-refresh", {
          method: "POST",
          cache:"no-store",
          headers: {"Cache-Control":"no-cache"}
        });
        const data = await resp.json();
        if (!data.ok){
          setResumen({msg:"Refresco fallÃ³: " + (data.error || "desconocido")});
          return;
        }
        setResumen({total:data.total_filas, cand:data.candidatos, msg:"Refresco OK (eTag fresco + descarga)"});
        // tras refrescar, volver a pintar detalle con un preview real (para tener lista completa)
        await apiPreview();
      }catch(e){
        setResumen({msg:"Fallo refresco: " + e});
      }finally{
        setBusy(false);
      }
    }

    async function apiGenerar(){
      setBusy(true);
      try{
        el("resultado").textContent = "Generando, por favor esperaâ€¦";
        const resp = await fetch("/generar-tarjetas", {
          method: "POST",
          cache:"no-store",
          headers: {"Cache-Control":"no-cache"}
        });
        const data = await resp.json();
        if (data.status){
          setResumen({msg:`Generadas: ${data.generadas}`});
        }else{
          setResumen({msg:`Error al generar: ${data.error || "desconocido"}`});
        }
        // luego de generar, recontar para ver el nuevo nÃºmero de pendientes
        await apiPreview();
      }catch(e){
        setResumen({msg:"Fallo al generar: " + e});
      }finally{
        setBusy(false);
      }
    }

    // Wire events
    el("btnRecontar").addEventListener("click", apiPreview);
    el("btnRefresh").addEventListener("click", apiForceRefresh);
    el("btnGenerar").addEventListener("click", apiGenerar);

    // Al cargar la pÃ¡ginaâ€¦
    apiPreview();
  </script>
</body>
</html>
